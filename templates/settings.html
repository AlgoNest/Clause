{% extends "layout.html" %}
{% block title %}Settings{% endblock %}
{% block body %}
<main class="lg:ml-64 min-h-screen bg-gray-50">
  <div class="max-w-4xl mx-auto px-6 py-8">
    <div class="bg-white rounded-2xl shadow-lg border border-gray-200 p-8">
      <h1 class="text-3xl font-bold text-gray-900 mb-6">Settings</h1>

      <div class="space-y-8">
        <!-- API Keys Section -->
        <div>
          <h2 class="text-xl font-semibold text-gray-900 mb-4">API Configuration</h2>
          <div class="space-y-4">
            <!-- OpenAI API Key -->
            <div class="p-4 border border-gray-200 rounded-lg">
              <div class="flex items-center justify-between">
                <div>
                  <h3 class="font-medium text-gray-900">OpenAI API Key</h3>
                  <p class="text-sm text-gray-600">Required for AI-powered clause analysis</p>
                </div>
                <div class="flex items-center">
                  <span id="openai-status" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium">
                    <!-- Status will be set by JavaScript -->
                  </span>
                </div>
              </div>
              <div class="mt-3">
                <input
                  type="password"
                  id="openai-key"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  placeholder="sk-..."
                >
                <button
                  id="save-openai"
                  class="mt-2 px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 transition-colors"
                >
                  Save OpenAI Key
                </button>
              </div>
            </div>

            <!-- GitHub Token -->
            <div class="p-4 border border-gray-200 rounded-lg">
              <div class="flex items-center justify-between">
                <div>
                  <h3 class="font-medium text-gray-900">GitHub Personal Access Token</h3>
                  <p class="text-sm text-gray-600">Required for saving analyses to GitHub repository</p>
                </div>
                <div class="flex items-center">
                  <span id="github-status" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium">
                    <!-- Status will be set by JavaScript -->
                  </span>
                </div>
              </div>
              <div class="mt-3">
                <input
                  type="password"
                  id="github-token"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  placeholder="ghp_..."
                >
                <button
                  id="save-github"
                  class="mt-2 px-4 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 focus:ring-2 focus:ring-green-500 transition-colors"
                >
                  Save GitHub Token
                </button>
              </div>
            </div>

            <!-- GitHub Repo Settings -->
            <div class="p-4 border border-gray-200 rounded-lg">
              <h3 class="font-medium text-gray-900 mb-2">GitHub Repository Settings</h3>
              <div class="grid md:grid-cols-2 gap-4">
                <div>
                  <label for="github-owner" class="block text-sm font-medium text-gray-700 mb-1">Repository Owner</label>
                  <input
                    type="text"
                    id="github-owner"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    placeholder="username or organization"
                  >
                </div>
                <div>
                  <label for="github-repo" class="block text-sm font-medium text-gray-700 mb-1">Repository Name</label>
                  <input
                    type="text"
                    id="github-repo"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    placeholder="repo-name"
                  >
                </div>
              </div>
              <button
                id="save-repo-settings"
                class="mt-3 px-4 py-2 bg-purple-600 text-white font-semibold rounded-lg hover:bg-purple-700 focus:ring-2 focus:ring-purple-500 transition-colors"
              >
                Save Repository Settings
              </button>
            </div>
          </div>
        </div>

        <!-- System Status -->
        <div>
          <h2 class="text-xl font-semibold text-gray-900 mb-4">System Status</h2>
          <div class="grid md:grid-cols-3 gap-4">
            <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
              <h3 class="font-medium text-gray-900">Rule Engine</h3>
              <p class="text-sm text-gray-600 mt-1">Ready</p>
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                Operational
              </span>
            </div>
            <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
              <h3 class="font-medium text-gray-900">AI Service</h3>
              <p class="text-sm text-gray-600 mt-1" id="ai-service-status">Checking...</p>
              <span id="ai-service-indicator" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium">
                <!-- Status will be set by JavaScript -->
              </span>
            </div>
            <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
              <h3 class="font-medium text-gray-900">GitHub Service</h3>
              <p class="text-sm text-gray-600 mt-1" id="github-service-status">Checking...</p>
              <span id="github-service-indicator" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium">
                <!-- Status will be set by JavaScript -->
              </span>
            </div>
          </div>
        </div>

        <!-- Error Logs -->
        <div>
          <h2 class="text-xl font-semibold text-gray-900 mb-4">Recent Errors</h2>
          <div id="error-logs" class="bg-gray-50 rounded-lg border border-gray-200 p-4 max-h-64 overflow-y-auto">
            <p class="text-sm text-gray-600">No recent errors.</p>
          </div>
          <button
            id="clear-errors"
            class="mt-3 px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 focus:ring-2 focus:ring-red-500 transition-colors"
          >
            Clear Error Logs
          </button>
        </div>
      </div>
    </div>
  </div>
</main>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const openaiKeyInput = document.getElementById('openai-key');
    const githubTokenInput = document.getElementById('github-token');
    const githubOwnerInput = document.getElementById('github-owner');
    const githubRepoInput = document.getElementById('github-repo');
    const saveOpenaiBtn = document.getElementById('save-openai');
    const saveGithubBtn = document.getElementById('save-github');
    const saveRepoBtn = document.getElementById('save-repo-settings');
    const clearErrorsBtn = document.getElementById('clear-errors');

    // Load current settings
    loadSettings();

    // Save handlers
    saveOpenaiBtn.addEventListener('click', () => saveSetting('openai_key', openaiKeyInput.value));
    saveGithubBtn.addEventListener('click', () => saveSetting('github_token', githubTokenInput.value));
    saveRepoBtn.addEventListener('click', () => saveRepoSettings());
    clearErrorsBtn.addEventListener('click', () => clearErrorLogs());

    async function loadSettings() {
      try {
        const response = await fetch('/api/settings');
        const data = await response.json();

        // Update status indicators
        updateStatus('openai-status', data.openai_configured ? 'Configured' : 'Not Configured', data.openai_configured);
        updateStatus('github-status', data.github_configured ? 'Configured' : 'Not Configured', data.github_configured);
        updateStatus('ai-service-indicator', data.ai_service_status, data.ai_service_operational);
        updateStatus('github-service-indicator', data.github_service_status, data.github_service_operational);

        document.getElementById('ai-service-status').textContent = data.ai_service_status;
        document.getElementById('github-service-status').textContent = data.github_service_status;

        // Populate inputs if available (masked for security)
        if (data.openai_configured) openaiKeyInput.placeholder = '••••••••••••••••';
        if (data.github_configured) githubTokenInput.placeholder = '••••••••••••••••';
        githubOwnerInput.value = data.github_owner || '';
        githubRepoInput.value = data.github_repo || '';

        // Load error logs
        loadErrorLogs(data.error_logs);
      } catch (error) {
        console.error('Failed to load settings:', error);
      }
    }

    function updateStatus(elementId, text, isOperational) {
      const element = document.getElementById(elementId);
      element.textContent = text;
      element.className = `inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
        isOperational ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
      }`;
    }

    async function saveSetting(key, value) {
      try {
        const response = await fetch('/api/settings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ [key]: value })
        });
        const data = await response.json();
        if (response.ok) {
          alert('Setting saved successfully!');
          loadSettings();
        } else {
          alert('Failed to save setting: ' + data.error);
        }
      } catch (error) {
        alert('Error saving setting: ' + error.message);
      }
    }

    async function saveRepoSettings() {
      try {
        const response = await fetch('/api/settings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            github_owner: githubOwnerInput.value,
            github_repo: githubRepoInput.value
          })
        });
        const data = await response.json();
        if (response.ok) {
          alert('Repository settings saved successfully!');
          loadSettings();
        } else {
          alert('Failed to save repository settings: ' + data.error);
        }
      } catch (error) {
        alert('Error saving repository settings: ' + error.message);
      }
    }

    function loadErrorLogs(logs) {
      const errorLogsDiv = document.getElementById('error-logs');
      if (logs && logs.length > 0) {
        errorLogsDiv.innerHTML = logs.map(log =>
          `<div class="text-sm text-red-600 py-1">${new Date(log.timestamp).toLocaleString()}: ${log.message}</div>`
        ).join('');
      } else {
        errorLogsDiv.innerHTML = '<p class="text-sm text-gray-600">No recent errors.</p>';
      }
    }

    async function clearErrorLogs() {
      try {
        const response = await fetch('/api/settings/clear-errors', { method: 'POST' });
        if (response.ok) {
          loadSettings();
        } else {
          alert('Failed to clear error logs');
        }
      } catch (error) {
        alert('Error clearing error logs: ' + error.message);
      }
    }
  });
</script>
{% endblock %}
