{% extends "layout.html" %}
{% block title %}Clause Analyzer{% endblock %}

{% block body %}

<div class="relative isolate px-6 pt-14 lg:px-8">

  <!-- Navbar -->
  <nav class="flex items-center justify-between py-4 mb-16">
    <div class="flex items-center space-x-2">
      <span class="text-2xl font-semibold">Clause</span>
      <span class="text-sm text-gray-500">AI Analyzer</span>
    </div>
  </nav>

  <!-- Hero -->
  <div class="mx-auto max-w-2xl py-16 text-center">
    <h1 class="text-4xl font-bold sm:text-6xl">Review Rental Contracts Instantly</h1>
    <p class="mt-6 text-lg text-gray-600">Paste text or upload a file. Analysis will be generated using AI + rule-based logic.</p>
  </div>

  <!-- Error Toast -->
  <div id="errorBox" class="hidden max-w-3xl mx-auto mb-6 p-4 rounded-xl bg-red-100 border border-red-300 text-red-800 text-sm">
  </div>

  <!-- Main Card -->
  <div class="mx-auto max-w-3xl mt-6 mb-20 bg-white shadow-xl rounded-2xl p-8 border border-gray-200">
    <h2 class="text-2xl font-semibold mb-4">Analyze Your Contract</h2>

    <form id="analyzeForm" action="/analyze" method="POST" enctype="multipart/form-data" class="space-y-6">

      <!-- Sample Button -->
      <button type="button"
              id="sampleBtn"
              class="w-full mb-4 rounded-xl bg-gray-900 py-2 text-white font-semibold text-sm hover:bg-gray-700">
        Use Sample Contract
      </button>

      <!-- Textarea -->
      <div>
        <label class="block mb-2 text-sm font-medium text-gray-700">Contract Text</label>
        <textarea name="contract_text" id="contractText"
                  rows="8"
                  class="w-full rounded-xl border border-gray-300 p-4 focus:ring-2 focus:ring-indigo-500"
                  placeholder="Paste text or upload a file..."></textarea>
      </div>

      <!-- File Upload -->
      <div>
        <label class="block mb-2 text-sm font-medium text-gray-700">Upload Contract File</label>
        <input type="file" id="fileInput" name="contract_file"
               class="w-full rounded-xl border border-gray-300 p-3 bg-gray-50 cursor-pointer" />
      </div>

      <!-- Analyze Button -->
      <button type="submit"
              class="w-full rounded-xl bg-indigo-600 py-3 text-white font-semibold text-lg hover:bg-indigo-700 shadow">
        Analyze Contract
      </button>

    </form>
  </div>
</div>


<!-- PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.6.172/pdf.min.js"></script>

<!-- DOCX text extraction -->
<script src="https://cdn.jsdelivr.net/npm/mammoth/mammoth.browser.min.js"></script>

<script>

function showError(message) {
    const box = document.getElementById("errorBox");
    box.textContent = message;
    box.classList.remove("hidden");
    setTimeout(() => box.classList.add("hidden"), 6000);
}

/* ------------------------------------
   SAMPLE CONTRACT BUTTON
------------------------------------ */
document.getElementById("sampleBtn").addEventListener("click", function () {
    try {
        const sample = `
RENTAL AGREEMENT

This Rental Agreement is between the Landlord and Tenant.

1. Rent must be paid on time.
2. Security deposit is refundable unless damages occur.
3. Tenant must follow property rules.
4. Landlord must provide 30-day notice for termination.
5. Tenant may not sublet without written permission.

Signed by both parties.
        `;
        document.getElementById("contractText").value = sample.trim();
    } catch (err) {
        showError("Failed to load sample contract. Please try again.");
    }
});


/* ------------------------------------
   FILE â†’ TEXT CONVERSION + ERRORS
------------------------------------ */
document.getElementById("fileInput").addEventListener("change", async function () {
    const file = this.files[0];
    if (!file) return;

    if (file.size > 5 * 1024 * 1024) {
        showError("File too large. Maximum allowed: 5 MB");
        this.value = "";
        return;
    }

    const ext = file.name.split(".").pop().toLowerCase();
    const supported = ["pdf", "txt", "docx"];

    if (!supported.includes(ext)) {
        showError("Unsupported file type. Allowed: PDF, TXT, DOCX.");
        this.value = "";
        return;
    }

    try {
        if (ext === "pdf") extractPDF(file);
        if (ext === "txt") extractTXT(file);
        if (ext === "docx") extractDOCX(file);
    } catch (error) {
        showError("Failed to extract text from file. Try another file.");
    }
});


/* ----- Extract PDF ----- */
async function extractPDF(file) {
    try {
        const buffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: buffer }).promise;
        let text = "";

        for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const content = await page.getTextContent();
            text += content.items.map(i => i.str).join(" ") + "\n";
        }

        document.getElementById("contractText").value = text;
    } catch {
        showError("Error reading PDF file.");
    }
}

/* ----- Extract TXT ----- */
function extractTXT(file) {
    const reader = new FileReader();
    reader.onerror = () => showError("Error reading TXT file.");
    reader.onload = () => document.getElementById("contractText").value = reader.result;
    reader.readAsText(file);
}

/* ----- Extract DOCX ----- */
async function extractDOCX(file) {
    try {
        const buffer = await file.arrayBuffer();
        const result = await mammoth.extractRawText({ arrayBuffer: buffer });
        document.getElementById("contractText").value = result.value;
    } catch {
        showError("Error reading DOCX file.");
    }
}


/* ------------------------------------
   VALIDATE BEFORE SUBMIT
------------------------------------ */
document.getElementById("analyzeForm").addEventListener("submit", function (e) {
    const text = document.getElementById("contractText").value.trim();

    if (!text) {
        e.preventDefault();
        showError("Please paste text, upload a file, or use the sample contract before analyzing.");
        return;
    }
});
</script>

{% endblock %}
